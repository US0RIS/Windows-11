<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Windows 11 Emulator ‚Äì GitHub Ready</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
html,body{
  margin:0;padding:0;width:100%;height:100%;overflow:hidden;
  background:#020617;color:#0f172a;
  font-family:"Segoe UI Variable","Segoe UI",-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
}
#desktop{
  position:absolute;inset:0;
  /* Windows 11-style light wallpaper with blue swirl cluster (no actual MS asset) */
  background:
    radial-gradient(circle at 30% 60%, rgba(37,99,235,0.98) 0, rgba(37,99,235,0.98) 26%, transparent 60%),
    radial-gradient(circle at 60% 60%, rgba(59,130,246,0.96) 0, rgba(59,130,246,0.96) 24%, transparent 58%),
    radial-gradient(circle at 45% 40%, rgba(96,165,250,0.88) 0, rgba(96,165,250,0.88) 26%, transparent 55%),
    linear-gradient(135deg,#e5f0ff 0,#dbeafe 40%,#cbd5f5 100%);
}

/* Desktop icons */
.icon{
  position:absolute;
  width:80px;
  text-align:center;
  cursor:pointer;
  user-select:none;
}
.icon-inner{
  width:48px;
  height:48px;
  margin:0 auto 4px;
  border-radius:14px;
  background:#1d4ed8;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  box-shadow:0 10px 20px rgba(15,23,42,0.35);
}
.icon-label{
  font-size:12px;
  text-shadow:0 1px 2px rgba(255,255,255,0.7);
  color:#020617;
}

/* Taskbar: full-width acrylic bar like Win11 */
#taskbar{
  position:absolute;
  left:0;right:0;bottom:0;
  height:44px;
  background:rgba(15,23,42,0.96);
  border-top:1px solid rgba(148,163,184,0.35);
  display:flex;
  align-items:center;
  padding:0;
  z-index:200;
  backdrop-filter:blur(22px);
  pointer-events:none;
}
#taskbar-inner{
  margin:0;
  height:100%;
  width:100%;
  max-width:100%;
  background:transparent;
  border-radius:0;
  border:none;
  box-shadow:none;
  padding:0 14px;
  display:flex;
  align-items:center;
  pointer-events:auto;
}
#taskbar-left,
#taskbar-center,
#taskbar-right{
  display:flex;
  align-items:center;
}
#taskbar-left{
  gap:4px;
}
#taskbar-center{
  flex:1;
  justify-content:center;
  gap:4px;
}
#taskbar-right{
  gap:10px;
  min-width:190px;
  justify-content:flex-end;
}

/* Start + fixed taskbar icons */
.tb-icon{
  width:32px;
  height:32px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  color:#f9fafb;
  font-size:18px;
}
.tb-icon:hover{
  background:rgba(148,163,184,0.35);
}

/* Start button with Windows-style logo */
#start-button{
  width:32px;
  height:32px;
  border-radius:9px;
  border:none;
  background:transparent;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}
#start-logo{
  width:20px;
  height:20px;
  border-radius:4px;
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:1px;
}
#start-logo div{
  background:#f9fafb;
}

/* Task buttons (for open windows) */
.task-button{
  padding:5px 10px;
  border-radius:10px;
  border:none;
  background:transparent;
  color:#e5e7eb;
  font-size:12px;
  cursor:pointer;
  white-space:nowrap;
  transition:background .15s ease;
}
.task-button.active{
  background:rgba(148,163,184,0.35);
}

/* Tray icons */
.tray-icon{
  width:22px;
  height:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.tray-icon svg{
  width:100%;
  height:100%;
  fill:#e5e7eb;
}
.timebox{
  font-size:11px;
  line-height:1.2;
  text-align:right;
  color:#f9fafb;
}

/* Windows */
.win{
  position:absolute;
  width:520px;
  height:380px;
  background:rgba(15,23,42,0.98);
  border-radius:14px;
  border:1px solid rgba(148,163,184,0.5);
  box-shadow:0 22px 55px rgba(0,0,0,0.9);
  display:flex;
  flex-direction:column;
  z-index:100;
  backdrop-filter:blur(16px);
}
.whead{
  height:34px;
  display:flex;
  align-items:center;
  padding:0 10px;
  background:linear-gradient(90deg,rgba(148,163,184,0.3),rgba(15,23,42,0.95));
  cursor:move;
}
.wtitle{
  flex:1;
  font-size:13px;
  color:#f9fafb;
}
.win-controls{
  display:flex;
  gap:2px;
}
.win-btn{
  width:36px;
  height:28px;
  border-radius:3px;
  border:none;
  background:transparent;
  color:#e5e7eb;
  cursor:pointer;
  font-size:14px;
}
.win-btn span{
  position:relative;
  top:-1px;
}
.win-btn:hover{
  background:rgba(148,163,184,0.3);
}
.win-btn.close{
  border-radius:4px;
}
.win-btn.close:hover{
  background:#dc2626;
}
.wbody{
  flex:1;
  padding:10px;
  overflow:auto;
  font-size:13px;
  color:#e5e7eb;
}

/* App content */
iframe{
  width:100%;height:100%;
  border:none;border-radius:10px;
  background:#020617;
}
textarea{
  width:100%;height:100%;
  background:#020617;border:none;border-radius:10px;
  color:#e5e7eb;
  font-family:Consolas,monospace;
  font-size:13px;
  padding:8px;
  box-sizing:border-box;
}
canvas{
  background:#020617;
  border-radius:10px;
  display:block;
  margin:0 auto;
}

/* Start menu */
#start-menu{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:520px;
  max-width:95vw;
  height:460px;
  background:rgba(15,23,42,0.96);
  border-radius:22px;
  border:1px solid rgba(148,163,184,0.55);
  box-shadow:0 28px 80px rgba(0,0,0,0.95);
  padding:18px 20px 12px;
  box-sizing:border-box;
  display:none;
  z-index:250;
  backdrop-filter:blur(22px);
}
#start-top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  font-size:12px;
  color:#9ca3af;
}
#start-user{
  display:flex;
  align-items:center;
  gap:8px;
}
#start-user-avatar{
  width:28px;
  height:28px;
  border-radius:999px;
  background:linear-gradient(135deg,#38bdf8,#a855f7);
}
#start-pinned-title,
#start-rec-title{
  font-size:12px;
  color:#9ca3af;
  margin:8px 0 6px;
}
#start-grid{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:10px;
}
.start-tile{
  height:76px;
  border-radius:12px;
  background:#111827;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:11px;
  cursor:pointer;
}
.start-tile:hover{
  background:#1f2937;
}
.start-tile-icon{
  width:30px;height:30px;
  border-radius:9px;
  background:#1d4ed8;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:4px;
  font-size:18px;
}
#start-rec{
  margin-top:4px;
  border-radius:14px;
  background:#020617;
  padding:6px 8px;
  box-sizing:border-box;
}
.rec-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:4px 4px;
  border-radius:8px;
  font-size:11px;
}
.rec-item:hover{
  background:#111827;
}
.rec-left{
  display:flex;
  align-items:center;
  gap:8px;
}
.rec-icon{
  width:22px;height:22px;
  border-radius:6px;
  background:#1f2937;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
}
.rec-meta{
  display:flex;
  flex-direction:column;
}
.rec-name{
  font-size:11px;
}
.rec-sub{
  color:#9ca3af;
  font-size:10px;
}
.rec-right{
  color:#9ca3af;
  font-size:10px;
}
#start-search{
  width:100%;
  margin-top:10px;
  padding:7px 10px;
  border-radius:8px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
  font-size:12px;
  box-sizing:border-box;
}

/* Quick settings panel */
#quick-panel{
  position:absolute;
  bottom:80px;
  right:24px;
  width:340px;
  background:rgba(15,23,42,0.96);
  border-radius:20px;
  border:1px solid rgba(148,163,184,0.55);
  box-shadow:0 28px 80px rgba(0,0,0,0.95);
  padding:14px 14px 12px;
  box-sizing:border-box;
  display:none;
  z-index:260;
  backdrop-filter:blur(22px);
  font-size:12px;
}
.q-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:10px;
}
.q-tile{
  border-radius:12px;
  background:#111827;
  padding:8px 6px;
  box-sizing:border-box;
  text-align:center;
  cursor:pointer;
}
.q-tile.active{
  background:#1d4ed8;
}
.q-tile-label{
  font-size:11px;
  margin-top:4px;
}
.q-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.q-label{
  color:#d1d5db;
}
.q-slider{
  width:100%;
}

/* Store app styles */
.store-layout{
  display:flex;
  height:100%;
  gap:10px;
}
.store-sidebar{
  width:120px;
  border-radius:12px;
  background:#020617;
  padding:8px;
  box-sizing:border-box;
  font-size:12px;
}
.store-sidebar-title{
  font-weight:600;
  margin-bottom:6px;
}
.store-sidebar-item{
  padding:4px 6px;
  border-radius:8px;
  cursor:pointer;
}
.store-sidebar-item.active,
.store-sidebar-item:hover{
  background:#1f2937;
}
.store-main{
  flex:1;
  border-radius:12px;
  background:#020617;
  padding:8px 10px;
  box-sizing:border-box;
}
.store-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.store-search{
  flex:1;
  margin-left:8px;
  padding:5px 8px;
  border-radius:8px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
  font-size:12px;
}
.store-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:8px;
}
.store-card{
  border-radius:12px;
  background:#0b1120;
  padding:8px;
  font-size:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.store-card-top{
  display:flex;
  gap:8px;
}
.store-card-icon{
  width:32px;height:32px;
  border-radius:10px;
  background:#1d4ed8;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}
.store-card-title{
  font-weight:600;
}
.store-card-desc{
  color:#9ca3af;
  font-size:11px;
}
.store-card-btn{
  align-self:flex-start;
  padding:4px 10px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:#1d4ed8;
  color:#f9fafb;
  font-size:11px;
}
.store-card-btn.installed{
  background:#16a34a;
}

/* Settings app */
.settings-layout{
  display:flex;
  height:100%;
  gap:10px;
}
.settings-sidebar{
  width:140px;
  border-radius:12px;
  background:#020617;
  padding:10px;
  box-sizing:border-box;
  font-size:12px;
}
.settings-sidebar-title{
  font-weight:600;
  margin-bottom:8px;
}
.settings-sidebar-item{
  padding:6px 8px;
  border-radius:8px;
  cursor:pointer;
}
.settings-sidebar-item.active,
.settings-sidebar-item:hover{
  background:#1f2937;
}
.settings-main{
  flex:1;
  border-radius:12px;
  background:#020617;
  padding:10px 12px;
  box-sizing:border-box;
  font-size:13px;
}
.settings-section-title{
  font-size:14px;
  font-weight:600;
  margin-bottom:8px;
}
.wallpaper-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:8px;
}
.wallpaper-thumb{
  height:70px;
  border-radius:10px;
  border:2px solid transparent;
  cursor:pointer;
  position:relative;
  overflow:hidden;
}
.wallpaper-thumb::after{
  content:"";
  position:absolute;
  inset:0;
}
.wallpaper-thumb.active{
  border-color:#38bdf8;
}
.wallpaper-thumb-default::after{
  background:
    radial-gradient(circle at 30% 60%, rgba(37,99,235,0.98) 0, rgba(37,99,235,0.98) 26%, transparent 60%),
    radial-gradient(circle at 60% 60%, rgba(59,130,246,0.96) 0, rgba(59,130,246,0.96) 24%, transparent 58%),
    radial-gradient(circle at 45% 40%, rgba(96,165,250,0.88) 0, rgba(96,165,250,0.88) 26%, transparent 55%),
    linear-gradient(135deg,#e5f0ff 0,#dbeafe 40%,#cbd5f5 100%);
}
.wallpaper-thumb-dark::after{
  background:radial-gradient(circle at 10% 0%,#0f172a,#020617 55%);
}
.wallpaper-thumb-blue::after{
  background:linear-gradient(135deg,#1d4ed8,#3b82f6);
}
.settings-note{
  font-size:11px;
  color:#9ca3af;
  margin-top:8px;
}

/* Task view overlay */
#taskview-overlay{
  position:absolute;
  inset:0;
  background:rgba(15,23,42,0.75);
  backdrop-filter:blur(16px);
  display:none;
  z-index:300;
}
#taskview-inner{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  max-width:80vw;
  max-height:70vh;
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  justify-content:center;
  overflow:auto;
}
.taskview-card{
  width:200px;
  height:120px;
  border-radius:12px;
  background:#020617;
  border:1px solid rgba(148,163,184,0.6);
  padding:8px;
  box-sizing:border-box;
  cursor:pointer;
  font-size:12px;
  color:#e5e7eb;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.taskview-card-title{
  font-weight:600;
}
.taskview-card-sub{
  font-size:11px;
  color:#9ca3af;
}
</style>
</head>
<body>

<div id="desktop">
  <!-- System apps -->
  <div class="icon" style="top:20px;left:20px" data-app="browser">
    <div class="icon-inner">üåê</div><div class="icon-label">Browser</div>
  </div>
  <div class="icon" style="top:120px;left:20px" data-app="notes">
    <div class="icon-inner">üìù</div><div class="icon-label">Notes</div>
  </div>
  <div class="icon" style="top:220px;left:20px" data-app="files">
    <div class="icon-inner">üóÇÔ∏è</div><div class="icon-label">Files</div>
  </div>

  <!-- Games -->
  <div class="icon" style="top:20px;left:140px" data-app="snake">
    <div class="icon-inner">üêç</div><div class="icon-label">Snake</div>
  </div>
  <div class="icon" style="top:120px;left:140px" data-app="tetris">
    <div class="icon-inner">üß±</div><div class="icon-label">Tetris</div>
  </div>
  <div class="icon" style="top:220px;left:140px" data-app="pong">
    <div class="icon-inner">üèì</div><div class="icon-label">Pong</div>
  </div>
  <div class="icon" style="top:320px;left:140px" data-app="flappy">
    <div class="icon-inner">üê§</div><div class="icon-label">Flappy</div>
  </div>
  <div class="icon" style="top:420px;left:140px" data-app="mines">
    <div class="icon-inner">üí£</div><div class="icon-label">Mines</div>
  </div>
  <div class="icon" style="top:520px;left:140px" data-app="g2048">
    <div class="icon-inner">üî¢</div><div class="icon-label">2048</div>
  </div>

  <!-- Store & Settings column -->
  <div class="icon" style="top:20px;left:260px" data-app="store">
    <div class="icon-inner">üõçÔ∏è</div><div class="icon-label">Store</div>
  </div>
  <div class="icon" style="top:120px;left:260px" data-app="settings">
    <div class="icon-inner">‚öôÔ∏è</div><div class="icon-label">Settings</div>
  </div>
</div>

<!-- Start menu -->
<div id="start-menu">
  <div id="start-top-row">
    <div>Start</div>
    <div id="start-user">
      <div id="start-user-avatar"></div>
      <div>Guest</div>
    </div>
  </div>

  <div id="start-pinned-title">Pinned</div>
  <div id="start-grid"></div>

  <div id="start-rec-title">Recommended</div>
  <div id="start-rec">
    <div class="rec-item">
      <div class="rec-left">
        <div class="rec-icon">üìù</div>
        <div class="rec-meta">
          <div class="rec-name">Notes.txt</div>
          <div class="rec-sub">Text Document</div>
        </div>
      </div>
      <div class="rec-right">Just now</div>
    </div>
    <div class="rec-item">
      <div class="rec-left">
        <div class="rec-icon">üéÆ</div>
        <div class="rec-meta">
          <div class="rec-name">Snake</div>
          <div class="rec-sub">Game</div>
        </div>
      </div>
      <div class="rec-right">Recently</div>
    </div>
  </div>

  <input id="start-search" placeholder="Type to search (fake)" />
</div>

<!-- Quick settings panel -->
<div id="quick-panel">
  <div class="q-grid">
    <div id="tile-wifi" class="q-tile active">
      <div>üì∂</div>
      <div class="q-tile-label">Wi-Fi</div>
    </div>
    <div id="tile-bt" class="q-tile">
      <div>üåÄ</div>
      <div class="q-tile-label">Bluetooth</div>
    </div>
    <div id="tile-airplane" class="q-tile">
      <div>‚úàÔ∏è</div>
      <div class="q-tile-label">Airplane</div>
    </div>
  </div>
  <div class="q-row">
    <span class="q-label">Volume</span>
  </div>
  <input id="vol-slider" class="q-slider" type="range" min="0" max="100" value="70">
  <div class="q-row" style="margin-top:8px;">
    <span class="q-label">Battery</span>
    <span id="battery-status" class="q-label">100% ‚Ä¢ Plugged in</span>
  </div>
</div>

<!-- Task view overlay -->
<div id="taskview-overlay">
  <div id="taskview-inner"></div>
</div>

<!-- Taskbar -->
<div id="taskbar">
  <div id="taskbar-inner">
    <div id="taskbar-left">
      <!-- Start button -->
      <button id="start-button" title="Start">
        <div id="start-logo">
          <div></div><div></div>
          <div></div><div></div>
        </div>
      </button>

      <!-- Search, Task View, Widgets, Chat icons -->
      <div id="tb-search" class="tb-icon" title="Search">üîç</div>
      <div id="tb-taskview" class="tb-icon" title="Task view">üóî</div>
      <div id="tb-widgets" class="tb-icon" title="Widgets">‚¨õ</div>
      <div id="tb-chat" class="tb-icon" title="Chat">üí¨</div>
    </div>

    <div id="taskbar-center"></div>

    <div id="taskbar-right">
      <!-- Wi-Fi / Volume / Battery cluster -->
      <div id="wifi-icon" class="tray-icon" title="Network, volume, battery">
        <svg viewBox="0 0 24 24">
          <path d="M12 18.5c-.7 0-1.3.3-1.8.7l1.8 2.3 1.8-2.3c-.5-.4-1.1-.7-1.8-.7z"/>
          <path d="M4.9 13.6 3 11.7C5.5 9.2 8.6 8 12 8s6.5 1.2 9 3.7l-1.9 1.9C17.2 11.7 14.8 11 12 11s-5.2.7-7.1 2.6z"/>
          <path d="M8.3 17 6.4 15.1C7.9 13.6 9.8 13 12 13s4.1.6 5.6 2.1L15.7 17C14.6 15.9 13.4 15.5 12 15.5S9.4 15.9 8.3 17z"/>
        </svg>
      </div>
      <div id="volume-icon" class="tray-icon" title="Volume">
        <svg viewBox="0 0 24 24">
          <path d="M4 9v6h3l4 4V5L7 9H4z"/>
          <path d="M16.5 8.1 15.1 9.5c.6.6.9 1.4.9 2.5s-.3 1.9-.9 2.5l1.4 1.4C17.5 14.9 18 13.8 18 12s-.5-2.9-1.5-3.9z"/>
        </svg>
      </div>
      <div id="battery-icon" class="tray-icon" title="Battery status">
        <svg viewBox="0 0 24 24">
          <rect x="3" y="8" width="14" height="8" rx="1.5" ry="1.5"/>
          <rect x="18" y="10" width="2" height="4" rx="1" ry="1"/>
          <rect x="4.5" y="9.5" width="9" height="5" fill="#22c55e"/>
        </svg>
      </div>

      <div class="timebox">
        <div id="clock-time"></div>
        <div id="clock-date"></div>
      </div>
    </div>
  </div>
</div>

<script>
let zCounter = 100;
const windowsMap = new Map();
const desktop = document.getElementById("desktop");
let dynamicIconCount = 1;

const appMeta = {
  browser:{label:"Browser",icon:"üåê"},
  notes:{label:"Notes",icon:"üìù"},
  files:{label:"Files",icon:"üóÇÔ∏è"},
  snake:{label:"Snake",icon:"üêç"},
  tetris:{label:"Tetris",icon:"üß±"},
  pong:{label:"Pong",icon:"üèì"},
  flappy:{label:"Flappy",icon:"üê§"},
  mines:{label:"Mines",icon:"üí£"},
  g2048:{label:"2048",icon:"üî¢"},
  store:{label:"Store",icon:"üõçÔ∏è"},
  paint:{label:"Paint",icon:"üé®"},
  music:{label:"Music",icon:"üéµ"},
  weather:{label:"Weather",icon:"‚òÄÔ∏è"},
  settings:{label:"Settings",icon:"‚öôÔ∏è"}
};

/* ---------- Clock ---------- */
function updateClock(){
  const now = new Date();
  document.getElementById("clock-time").textContent =
    now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  document.getElementById("clock-date").textContent =
    now.toLocaleDateString([], {month:"short", day:"numeric"});
}
updateClock();
setInterval(updateClock, 1000);

/* ---------- Desktop icons: drag + open ---------- */
let dragIcon = null, dragOffsetX = 0, dragOffsetY = 0;

function setupIcon(icon){
  icon.addEventListener("mousedown", e=>{
    dragIcon = icon;
    dragOffsetX = e.clientX - icon.offsetLeft;
    dragOffsetY = e.clientY - icon.offsetTop;
  });
  icon.addEventListener("mouseup", ()=>{ dragIcon=null; });
  icon.addEventListener("dblclick", ()=>{
    const appId = icon.getAttribute("data-app");
    openApp(appId);
  });
}
document.querySelectorAll(".icon").forEach(setupIcon);

document.addEventListener("mousemove", e=>{
  if(!dragIcon) return;
  dragIcon.style.left = (e.clientX - dragOffsetX) + "px";
  dragIcon.style.top  = (e.clientY - dragOffsetY) + "px";
});
document.addEventListener("mouseup", ()=>{ dragIcon=null; });

/* ---------- Windows / Taskbar ---------- */
const taskbarCenter = document.getElementById("taskbar-center");

function bringToFront(win){
  win.style.zIndex = ++zCounter;
}
function makeDraggable(win){
  const header = win.querySelector(".whead");
  let dragging=false, offX=0, offY=0;
  header.addEventListener("mousedown", e=>{
    if(e.target.closest(".win-controls")) return;
    dragging=true;
    const rect = win.getBoundingClientRect();
    offX = e.clientX - rect.left;
    offY = e.clientY - rect.top;
    bringToFront(win);
  });
  document.addEventListener("mousemove", e=>{
    if(!dragging) return;
    win.style.left = (e.clientX - offX) + "px";
    win.style.top  = (e.clientY - offY) + "px";
  });
  document.addEventListener("mouseup", ()=>{ dragging=false; });
}

function addTaskButton(appId, title){
  const btn = document.createElement("button");
  btn.className = "task-button active";
  btn.textContent = title;
  btn.addEventListener("click", ()=>{
    const info = windowsMap.get(appId);
    if(!info) return;
    const w = info.window;
    const isHidden = (w.style.display === "none");
    if(isHidden || info.minimized){
      w.style.display = "flex";
      bringToFront(w);
      info.minimized = false;
      btn.classList.add("active");
    }else{
      w.style.display = "none";
      info.minimized = true;
      btn.classList.remove("active");
    }
  });
  taskbarCenter.appendChild(btn);
  return btn;
}
function removeTaskButton(btn){ btn.remove(); }

function minimizeWindow(appId){
  const info = windowsMap.get(appId);
  if(!info) return;
  info.window.style.display = "none";
  info.minimized = true;
  info.taskButton.classList.remove("active");
}
function toggleMaximizeWindow(appId){
  const info = windowsMap.get(appId);
  if(!info) return;
  const w = info.window;
  if(!info.maximized){
    const rect = w.getBoundingClientRect();
    info.prevRect = {left:rect.left, top:rect.top, width:rect.width, height:rect.height};
    w.style.left = "8px";
    w.style.top  = "8px";
    w.style.width = "calc(100% - 16px)";
    w.style.height = "calc(100% - 60px)";
    info.maximized = true;
  }else{
    if(info.prevRect){
      w.style.left   = info.prevRect.left + "px";
      w.style.top    = info.prevRect.top + "px";
      w.style.width  = info.prevRect.width + "px";
      w.style.height = info.prevRect.height + "px";
    }
    info.maximized = false;
  }
}
function closeWindow(appId){
  const info = windowsMap.get(appId);
  if(!info) return;
  info.window.remove();
  removeTaskButton(info.taskButton);
  windowsMap.delete(appId);
}

/* ---------- Open App ---------- */
function openApp(appId){
  if(windowsMap.has(appId)){
    const info = windowsMap.get(appId);
    const w = info.window;
    w.style.display = "flex";
    bringToFront(w);
    info.minimized = false;
    info.taskButton.classList.add("active");
    return;
  }

  const meta = appMeta[appId] || {label:appId};
  const win = document.createElement("div");
  win.className = "win";
  win.style.left = "220px";
  win.style.top  = "120px";
  win.style.zIndex = ++zCounter;
  win.innerHTML =
    "<div class='whead'>" +
      "<div class='wtitle'></div>" +
      "<div class='win-controls'>" +
        "<button class='win-btn'><span>‚Äî</span></button>" +
        "<button class='win-btn'><span>‚ñ°</span></button>" +
        "<button class='win-btn close'><span>‚úï</span></button>" +
      "</div>" +
    "</div>" +
    "<div class='wbody'></div>";
  document.body.appendChild(win);

  const body = win.querySelector(".wbody");
  const titleEl = win.querySelector(".wtitle");
  let title = meta.label;

  /* App content */
  if(appId==="browser"){
    body.innerHTML =
      "<input type='text' class='url-input' placeholder='Search or type URL' " +
      "style='width:100%;padding:6px;border-radius:8px;border:1px solid #4b5563;" +
      "background:#020617;color:#e5e7eb;box-sizing:border-box;margin-bottom:8px;font-size:13px'>" +
      "<iframe></iframe>";
    const input = body.querySelector(".url-input");
    const iframe = body.querySelector("iframe");
    input.addEventListener("keydown", function(e){
      if(e.key==="Enter"){
        let v = input.value.trim();
        if(!v) return;
        if(v.indexOf(".")===-1 && v.indexOf("http")==-1){
          v = "https://duckduckgo.com/?q=" + encodeURIComponent(input.value);
        }else if(v.indexOf("http")!==0){
          v = "https://" + v;
        }
        window.open(v,"_blank");
        const safe = v.replace(/</g,"&lt;");
        iframe.srcdoc = `
<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:system-ui;color:white;background:#020617;">
  <div style="text-align:center;">
    <div style="font-size:18px;margin-bottom:6px;">Opened in real browser:</div>
    <div style="font-size:12px;color:#38bdf8;word-wrap:break-word;">${safe}</div>
  </div>
</div>`;
      }
    });
  }else if(appId==="notes"){
    body.innerHTML = "<textarea spellcheck='false'>Type here...</textarea>";
  }else if(appId==="files"){
    body.innerHTML = "<p>Drop files onto the desktop to open them. They will be listed here as well.</p><ul id='file-list'></ul>";
  }else if(appId==="snake"){
    body.innerHTML = "<canvas id='snake-canvas' width='300' height='300'></canvas>";
    startSnake(body.querySelector("#snake-canvas"));
  }else if(appId==="tetris"){
    body.innerHTML = "<canvas id='tetris-canvas' width='220' height='380'></canvas>";
    startTetris(body.querySelector("#tetris-canvas"));
  }else if(appId==="pong"){
    body.innerHTML = "<canvas id='pong-canvas' width='320' height='200'></canvas>";
    startPong(body.querySelector("#pong-canvas"));
  }else if(appId==="flappy"){
    body.innerHTML = "<canvas id='flappy-canvas' width='320' height='400'></canvas>";
    startFlappy(body.querySelector("#flappy-canvas"));
  }else if(appId==="mines"){
    body.innerHTML = "<canvas id='mines-canvas' width='320' height='320'></canvas>";
    startMines(body.querySelector("#mines-canvas"));
  }else if(appId==="g2048"){
    body.innerHTML = "<canvas id='game2048-canvas' width='320' height='320'></canvas>";
    start2048(body.querySelector("#game2048-canvas"));
  }else if(appId==="store"){
    title = "Microsoft Store (Mock)";
    body.innerHTML = `
      <div class="store-layout">
        <div class="store-sidebar">
          <div class="store-sidebar-title">Store</div>
          <div class="store-sidebar-item active">Home</div>
          <div class="store-sidebar-item">Games</div>
          <div class="store-sidebar-item">Productivity</div>
        </div>
        <div class="store-main">
          <div class="store-header">
            <div>Featured apps</div>
            <input class="store-search" placeholder="Search (fake)" />
          </div>
          <div class="store-grid" id="store-grid"></div>
        </div>
      </div>`;
    buildStoreApps(body.querySelector("#store-grid"));
  }else if(appId==="paint"){
    body.innerHTML = "<p>Simple Paint (drag to draw)</p><canvas id='paint-canvas' width='420' height='260'></canvas>";
    startPaint(body.querySelector("#paint-canvas"));
  }else if(appId==="music"){
    body.innerHTML = `
      <p>Music Player (mock)</p>
      <ul>
        <li>‚ô´ Chill Beats ‚Äì Playing</li>
        <li>‚ô´ Focus Mode</li>
        <li>‚ô´ Retro Game OST</li>
      </ul>
      <p style="font-size:11px;color:#9ca3af;margin-top:8px;">This is just a mock player for fun.</p>`;
  }else if(appId==="weather"){
    body.innerHTML = `
      <p>Weather</p>
      <p style="font-size:40px;margin:10px 0;">72¬∞‚òÄÔ∏è</p>
      <p>Clear skies in Your City.</p>
      <p style="font-size:11px;color:#9ca3af;margin-top:8px;">Data is static ‚Äì this is a mock weather app.</p>`;
  }else if(appId==="settings"){
    title = "Settings";
    body.innerHTML = `
      <div class="settings-layout">
        <div class="settings-sidebar">
          <div class="settings-sidebar-title">Settings</div>
          <div class="settings-sidebar-item active">System</div>
          <div class="settings-sidebar-item" data-section="personalization">Personalization</div>
        </div>
        <div class="settings-main">
          <div class="settings-section-title">Personalization & wallpaper</div>
          <div class="wallpaper-grid">
            <div class="wallpaper-thumb wallpaper-thumb-default active" data-wallpaper="default"></div>
            <div class="wallpaper-thumb wallpaper-thumb-dark" data-wallpaper="dark"></div>
            <div class="wallpaper-thumb wallpaper-thumb-blue" data-wallpaper="blue"></div>
          </div>
          <div class="settings-note">
            Choose a wallpaper preset. You can also drag &amp; drop an image file onto the desktop to use it as a background.
          </div>
        </div>
      </div>`;
    setupSettings(body);
  }

  titleEl.textContent = title;
  makeDraggable(win);
  bringToFront(win);

  const info = {window:win, taskButton:null, appId, minimized:false, maximized:false, prevRect:null};
  const taskButton = addTaskButton(appId, title);
  info.taskButton = taskButton;
  windowsMap.set(appId, info);

  const btns = win.querySelectorAll(".win-btn");
  const btnMin = btns[0], btnMax = btns[1], btnClose = btns[2];
  btnMin.addEventListener("click", ()=> minimizeWindow(appId));
  btnMax.addEventListener("click", ()=> toggleMaximizeWindow(appId));
  btnClose.addEventListener("click", ()=> closeWindow(appId));
}

/* ---------- Drag & drop files (wallpaper / open) ---------- */
document.addEventListener("dragover", function(e){ e.preventDefault(); });
document.addEventListener("drop", function(e){
  e.preventDefault();
  const files = e.dataTransfer.files;
  if(!files || !files.length) return;
  const file = files[0];
  const name = file.name || "";
  const lower = name.toLowerCase();
  const ext = lower.split(".").pop();

  if(["png","jpg","jpeg","gif","webp"].indexOf(ext)!==-1){
    const url = URL.createObjectURL(file);
    desktop.style.background = "url("+url+") center/cover no-repeat";
    document.querySelectorAll(".wallpaper-thumb").forEach(t=>t.classList.remove("active"));
    return;
  }

  const reader = new FileReader();
  reader.onload = function(evt){
    const text = evt.target.result;

    if(ext==="txt"){
      openApp("notes");
      const info = windowsMap.get("notes");
      if(info){
        const ta = info.window.querySelector("textarea");
        if(ta) ta.value = text;
      }
    }else if(ext==="html" || ext==="htm"){
      openApp("browser");
      const info = windowsMap.get("browser");
      if(info){
        const frame = info.window.querySelector("iframe");
        const blob = new Blob([text], {type:"text/html"});
        frame.src = URL.createObjectURL(blob);
      }
    }else{
      openApp("files");
      const info = windowsMap.get("files");
      if(info){
        const list = info.window.querySelector("#file-list");
        if(list){
          const li = document.createElement("li");
          li.textContent = name;
          list.appendChild(li);
        }
      }
    }
  };
  if(ext==="txt" || ext==="html" || ext==="htm"){
    reader.readAsText(file);
  }else{
    reader.readAsArrayBuffer(file);
    openApp("files");
    const info = windowsMap.get("files");
    if(info){
      const list = info.window.querySelector("#file-list");
      if(list){
        const li = document.createElement("li");
        li.textContent = name;
        list.appendChild(li);
      }
    }
  }
});

/* ---------- Start menu + Quick settings + Task view ---------- */
const startMenu = document.getElementById("start-menu");
const quickPanel = document.getElementById("quick-panel");
const startButton = document.getElementById("start-button");
const wifiIcon = document.getElementById("wifi-icon");
const volumeIcon = document.getElementById("volume-icon");
const batteryIcon = document.getElementById("battery-icon");
const volSlider = document.getElementById("vol-slider");
const batteryStatus = document.getElementById("battery-status");
const startGrid = document.getElementById("start-grid");
const taskviewOverlay = document.getElementById("taskview-overlay");
const taskviewInner = document.getElementById("taskview-inner");

const tbSearch   = document.getElementById("tb-search");
const tbTaskView = document.getElementById("tb-taskview");
const tbWidgets  = document.getElementById("tb-widgets");
const tbChat     = document.getElementById("tb-chat");

const tileWifi = document.getElementById("tile-wifi");
const tileBt = document.getElementById("tile-bt");
const tileAirplane = document.getElementById("tile-airplane");

const pinnedApps = new Set([
  "browser","notes","files",
  "snake","tetris","pong","flappy","mines","g2048","store","settings","weather"
]);

function buildStartMenu(){
  startGrid.innerHTML="";
  pinnedApps.forEach(id=>{
    const meta = appMeta[id];
    if(!meta) return;
    const d=document.createElement("div");
    d.className="start-tile";
    d.innerHTML =
      "<div class='start-tile-icon'>"+meta.icon+"</div>" +
      "<div>"+meta.label+"</div>";
    d.addEventListener("click", ()=>{
      openApp(id);
      startMenu.style.display="none";
    });
    startGrid.appendChild(d);
  });
}
buildStartMenu();

function addStartTile(appId){
  if(pinnedApps.has(appId)) return;
  pinnedApps.add(appId);
  buildStartMenu();
}

function toggleStartMenu(){
  const isVisible = startMenu.style.display==="block";
  startMenu.style.display = isVisible ? "none" : "block";
  if(!isVisible) quickPanel.style.display="none";
}
function toggleQuickPanel(){
  const isVisible = quickPanel.style.display==="block";
  quickPanel.style.display = isVisible ? "none" : "block";
  if(!isVisible) startMenu.style.display="none";
}

startButton.addEventListener("click", toggleStartMenu);
wifiIcon.addEventListener("click", toggleQuickPanel);
volumeIcon.addEventListener("click", toggleQuickPanel);
batteryIcon.addEventListener("click", toggleQuickPanel);

/* Search button -> open Start + focus search */
tbSearch.addEventListener("click", ()=>{
  startMenu.style.display = "block";
  quickPanel.style.display = "none";
  const input = document.getElementById("start-search");
  if(input) input.focus();
});

/* Task view button -> overlay */
tbTaskView.addEventListener("click", ()=>{
  if(taskviewOverlay.style.display==="block"){
    taskviewOverlay.style.display="none";
    return;
  }
  rebuildTaskView();
  taskviewOverlay.style.display="block";
});

function rebuildTaskView(){
  taskviewInner.innerHTML = "";
  if(windowsMap.size===0){
    const msg = document.createElement("div");
    msg.style.color="#9ca3af";
    msg.textContent = "No open windows.";
    taskviewInner.appendChild(msg);
    return;
  }
  windowsMap.forEach((info, appId)=>{
    const card = document.createElement("div");
    card.className="taskview-card";
    const title = info.window.querySelector(".wtitle")?.textContent || appId;
    card.innerHTML = `
      <div class="taskview-card-title">${title}</div>
      <div class="taskview-card-sub">${appId}</div>
      <div class="taskview-card-sub">Click to switch</div>`;
    card.addEventListener("click", ()=>{
      taskviewOverlay.style.display="none";
      info.window.style.display="flex";
      info.minimized=false;
      bringToFront(info.window);
      info.taskButton.classList.add("active");
    });
    taskviewInner.appendChild(card);
  });
}

taskviewOverlay.addEventListener("click", e=>{
  if(e.target===taskviewOverlay){
    taskviewOverlay.style.display="none";
  }
});

/* Widgets -> Weather; Chat -> Notes (mock) */
tbWidgets.addEventListener("click", ()=> openApp("weather"));
tbChat.addEventListener("click", ()=> openApp("notes"));

/* Quick settings tile toggles (visual only) */
[tileWifi,tileBt,tileAirplane].forEach(tile=>{
  tile.addEventListener("click",()=>{
    tile.classList.toggle("active");
  });
});

volSlider.addEventListener("input", ()=>{
  const v = volSlider.value;
  batteryStatus.textContent = "100% ‚Ä¢ Volume " + v + "%";
});

/* ---------- App Store logic ---------- */
const installedApps = new Set();

function addDesktopIcon(appId){
  const meta = appMeta[appId];
  if(!meta) return;
  const icon = document.createElement("div");
  icon.className="icon";
  icon.style.top = (20 + dynamicIconCount*90) + "px";
  icon.style.left = "260px";
  icon.setAttribute("data-app", appId);
  icon.innerHTML =
    "<div class='icon-inner'>"+meta.icon+"</div>" +
    "<div class='icon-label'>"+meta.label+"</div>";
  desktop.appendChild(icon);
  setupIcon(icon);
  dynamicIconCount++;
}

function installApp(appId){
  if(installedApps.has(appId)) return;
  installedApps.add(appId);
  addDesktopIcon(appId);
  addStartTile(appId);
}

function buildStoreApps(container){
  const storeApps = [
    {id:"paint", desc:"Draw simple shapes and doodles."},
    {id:"music", desc:"Listen to a fake chill playlist."},
    {id:"weather", desc:"Check a pretend sunny forecast."},
    {id:"snake", desc:"Classic snake game."},
    {id:"tetris", desc:"Falling block puzzle."},
    {id:"g2048", desc:"Merge tiles to 2048."}
  ];
  container.innerHTML="";
  storeApps.forEach(app=>{
    const meta = appMeta[app.id];
    const card = document.createElement("div");
    card.className="store-card";
    card.innerHTML = `
      <div class="store-card-top">
        <div class="store-card-icon">${meta.icon}</div>
        <div>
          <div class="store-card-title">${meta.label}</div>
          <div class="store-card-desc">${app.desc}</div>
        </div>
      </div>
      <button class="store-card-btn" data-install="${app.id}">Install</button>
    `;
    const btn = card.querySelector("[data-install]");
    btn.addEventListener("click", ()=>{
      if(!installedApps.has(app.id)){
        installApp(app.id);
        btn.textContent="Open";
        btn.classList.add("installed");
      }else{
        openApp(app.id);
      }
    });
    container.appendChild(card);
  });
}

/* ---------- Settings helpers ---------- */
function setupSettings(root){
  const thumbs = root.querySelectorAll(".wallpaper-thumb");
  thumbs.forEach(thumb=>{
    thumb.addEventListener("click", ()=>{
      thumbs.forEach(t=>t.classList.remove("active"));
      thumb.classList.add("active");
      const mode = thumb.getAttribute("data-wallpaper");
      if(mode==="default"){
        desktop.style.background =
          "radial-gradient(circle at 30% 60%, rgba(37,99,235,0.98) 0, rgba(37,99,235,0.98) 26%, transparent 60%)," +
          "radial-gradient(circle at 60% 60%, rgba(59,130,246,0.96) 0, rgba(59,130,246,0.96) 24%, transparent 58%)," +
          "radial-gradient(circle at 45% 40%, rgba(96,165,250,0.88) 0, rgba(96,165,250,0.88) 26%, transparent 55%)," +
          "linear-gradient(135deg,#e5f0ff 0,#dbeafe 40%,#cbd5f5 100%)";
      }else if(mode==="dark"){
        desktop.style.background = "radial-gradient(circle at 10% 0%,#0f172a,#020617 55%)";
      }else if(mode==="blue"){
        desktop.style.background = "linear-gradient(135deg,#1d4ed8,#3b82f6)";
      }
    });
  });
}

/* ---------- Extra mini app (Paint) ---------- */
function startPaint(canvas){
  const ctx = canvas.getContext("2d");
  ctx.fillStyle="#020617";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  let drawing=false;
  canvas.addEventListener("mousedown",e=>{
    drawing=true;
    ctx.strokeStyle="#38bdf8";
    ctx.lineWidth=3;
    ctx.lineCap="round";
    ctx.beginPath();
    ctx.moveTo(e.offsetX,e.offsetY);
  });
  canvas.addEventListener("mousemove",e=>{
    if(!drawing) return;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
  });
  document.addEventListener("mouseup",()=>{drawing=false;});
}

/* ---------- Games ---------- */
function startSnake(canvas){
  const ctx = canvas.getContext("2d");
  const grid = 15;
  const tiles = 20;
  let snake = [{x:10,y:10}];
  let dir = {x:1,y:0};
  let pendingDir = dir;
  let food = {x:15,y:10};

  document.addEventListener("keydown", function(e){
    if(e.key==="ArrowUp" && dir.y===0) pendingDir={x:0,y:-1};
    if(e.key==="ArrowDown" && dir.y===0) pendingDir={x:0,y:1};
    if(e.key==="ArrowLeft" && dir.x===0) pendingDir={x:-1,y:0};
    if(e.key==="ArrowRight" && dir.x===0) pendingDir={x:1,y:0};
  });

  function randomFood(){
    food.x = Math.floor(Math.random()*tiles);
    food.y = Math.floor(Math.random()*tiles);
  }

  function step(){
    dir = pendingDir;
    const head = {
      x:(snake[0].x+dir.x+tiles)%tiles,
      y:(snake[0].y+dir.y+tiles)%tiles
    };
    if(snake.some(seg=>seg.x===head.x && seg.y===head.y)){
      snake = [{x:10,y:10}];
      dir = {x:1,y:0};
      pendingDir = dir;
      randomFood();
    }else{
      snake.unshift(head);
      if(head.x===food.x && head.y===food.y){
        randomFood();
      }else{
        snake.pop();
      }
    }

    ctx.fillStyle="#020617";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#22c55e";
    snake.forEach(seg=>{
      ctx.fillRect(seg.x*grid, seg.y*grid, grid-2, grid-2);
    });
    ctx.fillStyle="#ef4444";
    ctx.fillRect(food.x*grid, food.y*grid, grid-2, grid-2);
  }
  setInterval(step,100);
}

function startTetris(canvas){
  const ctx = canvas.getContext("2d");
  const cols=10, rows=18, size=20;
  const board = [];
  for(let r=0;r<rows;r++){ board[r]=new Array(cols).fill(0); }

  const shapes=[
    [[1,1,1,1]],
    [[1,1],[1,1]],
    [[0,1,0],[1,1,1]],
    [[1,0,0],[1,1,1]],
    [[0,0,1],[1,1,1]],
    [[1,1,0],[0,1,1]],
    [[0,1,1],[1,1,0]]
  ];
  const colors=["#0ea5e9","#eab308","#a855f7","#3b82f6","#f97316","#22c55e","#ef4444"];
  let piece=null, px=3, py=0;

  function newPiece(){
    const i=Math.floor(Math.random()*shapes.length);
    piece={shape:shapes[i], color:colors[i]};
    px=3; py=0;
    if(collides(0,0,piece.shape)){
      for(let r=0;r<rows;r++) board[r].fill(0);
    }
  }
  function collides(offX,offY,shape){
    for(let y=0;y<shape.length;y++){
      for(let x=0;x<shape[y].length;x++){
        if(!shape[y][x]) continue;
        const nx=px+x+offX, ny=py+y+offY;
        if(nx<0 || nx>=cols || ny>=rows) return true;
        if(ny>=0 && board[ny][nx]) return true;
      }
    }
    return false;
  }
  function merge(){
    piece.shape.forEach((row,y)=>{
      row.forEach((val,x)=>{
        if(val){
          const ny=py+y;
          if(ny>=0 && ny<rows) board[ny][px+x]=piece.color;
        }
      });
    });
  }
  function rotate(shape){
    const res=[];
    for(let x=0;x<shape[0].length;x++){
      const row=[];
      for(let y=shape.length-1;y>=0;y--){
        row.push(shape[y][x]);
      }
      res.push(row);
    }
    return res;
  }
  function clearLines(){
    for(let y=rows-1;y>=0;y--){
      if(board[y].every(Boolean)){
        board.splice(y,1);
        board.unshift(new Array(cols).fill(0));
        y++;
      }
    }
  }
  document.addEventListener("keydown",function(e){
    if(!piece) return;
    if(e.key==="ArrowLeft" && !collides(-1,0,piece.shape)) px--;
    if(e.key==="ArrowRight" && !collides(1,0,piece.shape)) px++;
    if(e.key==="ArrowDown") tick();
    if(e.key==="ArrowUp"){
      const rot=rotate(piece.shape);
      if(!collides(0,0,rot)) piece.shape=rot;
    }
  });

  function tick(){
    if(!piece) return;
    if(!collides(0,1,piece.shape)){
      py++;
    }else{
      merge();
      clearLines();
      newPiece();
    }
  }
  function draw(){
    ctx.fillStyle="#020617";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<rows;y++){
      for(let x=0;x<cols;x++){
        if(board[y][x]){
          ctx.fillStyle=board[y][x];
          ctx.fillRect(x*size,y*size,size-1,size-1);
        }
      }
    }
    if(piece){
      ctx.fillStyle=piece.color;
      piece.shape.forEach((row,y)=>{
        row.forEach((val,x)=>{
          if(val){
            const nx=px+x, ny=py+y;
            ctx.fillRect(nx*size,ny*size,size-1,size-1);
          }
        });
      });
    }
  }
  newPiece();
  setInterval(function(){tick();draw();},200);
}

function startPong(canvas){
  const ctx=canvas.getContext("2d");
  let bx=150,by=100,dx=3,dy=3,py=80,ai=80;
  canvas.addEventListener("mousemove",function(e){
    const rect=canvas.getBoundingClientRect();
    py=e.clientY-rect.top-30;
  });
  function loop(){
    ctx.fillStyle="#020617";ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#e5e7eb";
    ctx.fillRect(10,py,10,60);
    ctx.fillRect(canvas.width-20,ai,10,60);
    ctx.fillRect(bx,by,10,10);
    ai+= (by-ai-30)*0.05;
    bx+=dx;by+=dy;
    if(by<=0 || by>=canvas.height-10) dy*=-1;
    if(bx<=20 && by>py && by<py+60) dx*=-1;
    if(bx>=canvas.width-30 && by>ai && by<ai+60) dx*=-1;
    if(bx<0 || bx>canvas.width) dx*=-1;
    requestAnimationFrame(loop);
  }
  loop();
}

function startFlappy(canvas){
  const ctx=canvas.getContext("2d");
  let y=150,vy=0;
  const pipes=[];
  document.addEventListener("keydown",function(e){
    if(e.key===" ") vy=-6;
  });
  setInterval(function(){
    pipes.push({x:canvas.width, gapY:80+Math.random()*180});
  },2000);

  function loop(){
    ctx.fillStyle="#020617";ctx.fillRect(0,0,canvas.width,canvas.height);
    vy+=0.3;y+=vy;
    ctx.fillStyle="#facc15";
    ctx.fillRect(40,y,20,20);
    for(let i=0;i<pipes.length;i++){
      const p=pipes[i];
      p.x-=2;
      ctx.fillStyle="#22c55e";
      ctx.fillRect(p.x,0,40,p.gapY-60);
      ctx.fillRect(p.x,p.gapY,40,canvas.height-p.gapY);
      if(40<p.x+40 && 60>p.x &&
        (y<p.gapY-60 || y+20>p.gapY)){
        y=150;vy=0;pipes.length=0;break;
      }
    }
    requestAnimationFrame(loop);
  }
  loop();
}

function startMines(canvas){
  const ctx=canvas.getContext("2d");
  const size=10, cell=30, bombsCount=15;
  let cells;

  function initBoard(){
    cells=[];
    for(let y=0;y<size;y++){
      cells[y]=[];
      for(let x=0;x<size;x++){
        cells[y][x]={bomb:false,revealed:false,adj:0};
      }
    }
    let placed=0;
    while(placed<bombsCount){
      const x=Math.floor(Math.random()*size);
      const y=Math.floor(Math.random()*size);
      if(!cells[y][x].bomb){
        cells[y][x].bomb=true;placed++;
      }
    }
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        if(cells[y][x].bomb) continue;
        let n=0;
        for(let yy=-1;yy<=1;yy++){
          for(let xx=-1;xx<=1;xx++){
            const ny=y+yy,nx=x+xx;
            if(ny>=0&&ny<size&&nx>=0&&nx<size&&cells[ny][nx].bomb)n++;
          }
        }
        cells[y][x].adj=n;
      }
    }
  }

  function reveal(x,y){
    if(x<0||x>=size||y<0||y>=size) return;
    const c=cells[y][x];
    if(c.revealed) return;
    c.revealed=true;
    if(c.bomb){
      alert("Boom! Restarting game.");
      initBoard();
      draw();
      return;
    }
    if(c.adj===0){
      for(let yy=-1;yy<=1;yy++){
        for(let xx=-1;xx<=1;xx++){
          if(xx||yy) reveal(x+xx,y+yy);
        }
      }
    }
  }
  function draw(){
    ctx.fillStyle="#111827";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        const c=cells[y][x];
        ctx.strokeStyle="#4b5563";
        ctx.strokeRect(x*cell,y*cell,cell,cell);
        if(c.revealed){
          if(c.bomb){
            ctx.fillStyle="#ef4444";
            ctx.beginPath();
            ctx.arc(x*cell+15,y*cell+15,8,0,Math.PI*2);
            ctx.fill();
          }else if(c.adj>0){
            ctx.fillStyle="#e5e7eb";
            ctx.font="14px system-ui";
            ctx.textAlign="center";
            ctx.textBaseline="middle";
            ctx.fillText(String(c.adj),x*cell+15,y*cell+15);
          }
        }else{
          ctx.fillStyle="#1f2937";
          ctx.fillRect(x*cell+1,y*cell+1,cell-2,cell-2);
        }
      }
    }
  }

  canvas.onclick = function(e){
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/cell);
    const y=Math.floor((e.clientY-rect.top)/cell);
    reveal(x,y);
    draw();
  };

  initBoard();
  draw();
}

function start2048(canvas){
  const ctx=canvas.getContext("2d");
  const size=4;
  const grid=[];
  for(let y=0;y<size;y++){
    grid[y]=[];
    for(let x=0;x<size;x++) grid[y][x]=0;
  }
  function addTile(){
    const empty=[];
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        if(grid[y][x]===0) empty.push({x:x,y:y});
      }
    }
    if(!empty.length) return;
    const spot=empty[Math.floor(Math.random()*empty.length)];
    grid[spot.y][spot.x]=(Math.random()<0.9)?2:4;
  }
  function draw(){
    ctx.fillStyle="#020617";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const cell=70;
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        const v=grid[y][x];
        ctx.fillStyle=v? "#f59e0b":"#1f2937";
        ctx.fillRect(x*cell+5,y*cell+5,cell-10,cell-10);
        if(v){
          ctx.fillStyle="#111827";
          ctx.font="20px system-ui";
          ctx.textAlign="center";
          ctx.textBaseline="middle";
          ctx.fillText(String(v),x*cell+cell/2,y*cell+cell/2);
        }
      }
    }
  }
  function slide(row){
    const arr=row.filter(v=>v);
    for(let i=0;i<arr.length-1;i++){
      if(arr[i]===arr[i+1]){
        arr[i]*=2;
        arr[i+1]=0;
      }
    }
    const res=arr.filter(v=>v);
    while(res.length<size) res.push(0);
    return res;
  }
  function moveLeft(){
    let moved=false;
    for(let y=0;y<size;y++){
      const orig=grid[y].slice();
      const row=slide(grid[y]);
      grid[y]=row;
      if(row.toString()!==orig.toString()) moved=true;
    }
    if(moved) addTile();
    draw();
  }
  function moveRight(){
    let moved=false;
    for(let y=0;y<size;y++){
      const orig=grid[y].slice();
      let row=grid[y].slice().reverse();
      row=slide(row).reverse();
      grid[y]=row;
      if(row.toString()!==orig.toString()) moved=true;
    }
    if(moved) addTile();
    draw();
  }
  function moveUp(){
    let moved=false;
    for(let x=0;x<size;x++){
      const col=[];
      for(let y=0;y<size;y++) col.push(grid[y][x]);
      const orig=col.slice();
      let res=slide(col);
      for(let y=0;y<size;y++) grid[y][x]=res[y];
      if(res.toString()!==orig.toString()) moved=true;
    }
    if(moved) addTile();
    draw();
  }
  function moveDown(){
    let moved=false;
    for(let x=0;x<size;x++){
      const col=[];
      for(let y=0;y<size;y++) col.push(grid[y][x]);
      const orig=col.slice();
      let res=col.reverse();
      res=slide(res).reverse();
      for(let y=0;y<size;y++) grid[y][x]=res[y];
      if(res.toString()!==orig.toString()) moved=true;
    }
    if(moved) addTile();
    draw();
  }

  document.addEventListener("keydown",function(e){
    if(e.key==="ArrowLeft") moveLeft();
    if(e.key==="ArrowRight") moveRight();
    if(e.key==="ArrowUp") moveUp();
    if(e.key==="ArrowDown") moveDown();
  });

  addTile(); addTile(); draw();
}
</script>
</body>
</html>
